<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
  <title>탐험일지</title>
  <style>
    .wrap {
      width: 900px;
      margin: 10px auto;
    }
    .writeBtnStyle{
        width:500px;
        margin:auto;
        display: block;
    }
    #writeBox{
      margin: 10px auto 30px auto;
      width:800px;
      border: 3px solid #00D1B2;
      border-radius: 5px;
      padding: 50px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="jumbotron" style="background-color: #00D1B2; color: white;">
      <h1 class="display-4" style="font-weight: bold;">환영합니다, {{uname}}님</h1>
      <p class="lead" style="font-weight: bold;">{{uname}}님의 탐험일지</p>
      <p id="uuid" hidden>{{uid}}</p>
      <a href="/logout">
        <button class="button is-light text-uppercase" style="float: right; font-size: small;">로그아웃</button>
      </a>
    </div>
      <button class="button is-primary text-uppercase writeBtnStyle" id="writeBtn">작성하기</button>
    <div id="writeBox">
      <h5><span class="badge badge-secondary" style="background-color: #00D1B2;">Today story</span></h5>
      <div class="form-group">
        <input type="text" class="form-control" id="inputTitle" placeholder="제목 입력">
      </div>
      <div class="form-group">
        <textarea type="text" class="form-control" id="inputText" placeholder="내용 입력"></textarea>
      </div>
      <h5><span class="badge badge-secondary" style="background-color: #00D1B2;">Today condition</span></h5>
      <div class="row">
        <div class="form-group col-8">
          <select class="form-control" id="selectpicker">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <button id="submit_btn" class="button is-primary text-uppercase fw-bold mb-2" style="float: right;" onclick=submit() disabled>등록</button>
      </div>
    </div>
    <p></p>
    <div id="cardList" class="card-columns">
    </div>
  </div>
  <script type="text/javascript" src="{{url_for('static', filename='js/mypage_script.js')}}"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
  <script>
    $('#selectpicker').on('change', function(e){
      console.log(this.value);
    });
  </script>
  <script>
    $(document).ready(function() {
      const $writeBtn = $("#writeBtn");
      const $writeBox = $("#writeBox");
      const $cardList = $("#cardList");
      read(); //읽어옴?
      $writeBox.hide() //먼저 안 보이게
      $writeBtn.on('click', function(){
        if ($writeBtn.text() == '작성하기'){
          $writeBox.show()
          $writeBtn.text('작성닫기')
        } else {
          $writeBox.hide()
          $writeBtn.text('작성하기')
        }
      })

      $("#inputTitle").keyup(function(e){
        if(event.replace(/\s| /gi,"").length == 0){
          alert('제목을 입력해주세요.')
          $(this).focus()
        }
      })

    })
  </script>
  <script>
    function deleteArticle(node) {
      node.parentNode.remove();
      $.ajax({
        type: 'GET',
        url: '/deleteArticle/' + node.parentNode.id,
        success: function(data){
          console.log(data) //데이터 불러지고 있음 삭제해야할 코드
          if (data.result == "success"){
            alert("삭제 완료")
          } else {
            alert("error")
          }
        }
      })
      location.reload();
    }
  </script>
  <script>
    function submit() {
      var inputTitle = $("#inputTitle").val();
      var inputText = $("#inputText").val();
      var uid = document.getElementById("uuid").textContent;
    
      let today = new Date();
      let year = today.getFullYear(); // 년도
      let month = today.getMonth() + 1;  // 월
      let date = today.getDate();  // 날짜
      let day = today.getDay();  // 요일

      var e = document.getElementById("selectpicker");
      var level = e.value;
      
      var postdata = {
        'uid': uid,
        'title':inputTitle,
        'content':inputText,
        'level': level,
        'year': year,
        'month': month,
        'date': date,
        'day': day
      };
      $.ajax({
        type:'POST',
        url: '{{url_for("submitArticle")}}',
        data: JSON.stringify(postdata),
        dataType : 'JSON',
        contentType: "application/json",
        success: function (data) {
          if (data.result == "success") {
            alert('등록되었습니다.')
            location.reload()
          }
        }
      })
    }
    function read(){
      console.log('{{uid}}');
      $.ajax({
        type: 'GET',
        url: '/getArticle/' + '{{uid}}',
        success: function(data){
          console.log(data) //데이터 불러지고 있음 삭제해야할 코드
          if (data.result == "success"){
            // $cardList.empty(); //없애고 다시 띄우는, 새로고침
            for(let i=0; i<data.result2.length; i++){ //길이만큼 돌리고
              $("#cardList").append(makediary(data.result2[i]))
            }
          }
        }
      })
    }
    function makediary(diary){
      var div1 = document.createElement("div");
      div1.setAttribute('class', 'card');
      div1.setAttribute('id', diary._id);
      var div2 = document.createElement("div");
      div2.setAttribute('class', 'card-body');
      var h5 = document.createElement("h5");
      h5.setAttribute('class','card-title');
      h5.innerText = diary.title;
      var p = document.createElement("p");
      p.setAttribute('class','card-text');
      p.innerText = diary.content;
      var p2 = document.createElement("p");
      p2.setAttribute('class', 'card-text card-comment');
      p2.setAttribute('style', 'color: blue; font-weight: bold;');
      p2.innerText = diary.date
      var btn = document.createElement("button")
      btn.setAttribute('class', 'btn btn-dark btn-sm delete-memo-btn')
      btn.setAttribute('style', 'position:absolute; bottom:0; right:0; margin:10px')
      btn.setAttribute('id',diary.date)
      btn.setAttribute('onclick', "deleteArticle(this)");
      btn.innerText = "삭제"

      div2.appendChild(h5);
      div2.appendChild(p);
      div2.appendChild(p2);
      div1.appendChild(btn);

      div1.appendChild(div2);

      return div1;
    }
  </script>
</body>
</html>